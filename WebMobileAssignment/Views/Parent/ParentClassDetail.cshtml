@{
    ViewBag.Title = "Class Details";
    ViewBag.ActiveMenu = "Classes";
}

@{
    var student = ViewBag.Student as WebMobileAssignment.Models.Student;
 var classItem = ViewBag.Class as WebMobileAssignment.Models.Class;
    var attendances = ViewBag.Attendances as List<WebMobileAssignment.Models.Attendance> ?? new List<WebMobileAssignment.Models.Attendance>();
    
    // Calculate attendance statistics
    var totalAttendance = attendances.Count;
    var presentCount = attendances.Count(a => a.Status == "Present");
    var absentCount = attendances.Count(a => a.Status == "Absent");
    var lateCount = attendances.Count(a => a.Status == "Late");
    var attendanceRate = totalAttendance > 0 ? Math.Round((decimal)presentCount / totalAttendance * 100, 0) : 0;
    
    var statusBadge = attendanceRate >= 80 ? "success" : (attendanceRate >= 70 ? "warning" : "danger");
    var statusText = attendanceRate >= 80 ? "Good Standing" : (attendanceRate >= 70 ? "Needs Improvement" : "At Risk");
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
 <div class="col-12">
            <nav aria-label="breadcrumb">
   <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="@Url.Action("ParentClasses", "Parent")">Classes</a></li>
            <li class="breadcrumb-item active">@classItem?.ClassName</li>
       </ol>
        </nav>
       <h1 class="mb-2">@classItem?.ClassName</h1>
         <p class="text-muted">
  @student?.User?.FullName (ID: @student?.StudentId) | 
    Subject: @(classItem?.Subject?.SubjectName ?? "N/A")
            </p>
        </div>
    </div>

    <div class="row">
<!-- Class Information -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="dashboard-card">
     <div class="card-header">
           <h5 class="mb-0">
    <i class="bi bi-info-circle"></i> Class Information
       </h5>
 </div>
         <div class="card-body">
                    <div class="detail-row">
            <label class="label">Instructor:</label>
        <span class="value">@(classItem?.Teacher?.User?.FullName ?? "Not Assigned")</span>
  </div>
      <div class="detail-row">
            <label class="label">Schedule:</label>
              <span class="value">
@if (!string.IsNullOrEmpty(classItem?.Day) && classItem.StartTime.HasValue && classItem.EndTime.HasValue)
           {
    @($"{classItem.Day} - {classItem.StartTime.Value:hh\\:mm} to {classItem.EndTime.Value:hh\\:mm}")
       }
  else
        {
      @("TBA")
        }
          </span>
       </div>
            <div class="detail-row">
               <label class="label">Location:</label>
             <span class="value">@(classItem?.RoomNumber ?? "TBA")</span>
     </div>
          <div class="detail-row">
   <label class="label">Capacity:</label>
      <span class="value">@classItem?.CurrentCapacity / @classItem?.MaxCapacity</span>
     </div>
    <div class="detail-row">
   <label class="label">Status:</label>
   <span class="value">
          <span class="badge bg-@statusBadge">@statusText</span>
             </span>
        </div>
</div>
            </div>
        </div>

        <!-- Child's Performance -->
        <div class="col-lg-4 col-md-6 mb-4">
      <div class="dashboard-card">
      <div class="card-header">
<h5 class="mb-0">
    <i class="bi bi-graph-up"></i> Performance Overview
         </h5>
  </div>
         <div class="card-body">
     <div class="perf-row">
          <span>Attendance Rate:</span>
            <strong class="text-@statusBadge">@attendanceRate%</strong>
    </div>
     <div class="perf-row">
    <span>Total Classes:</span>
           <strong>@totalAttendance</strong>
          </div>
         <div class="perf-row">
            <span>Present:</span>
      <strong class="text-success">@presentCount</strong>
            </div>
 <div class="perf-row">
              <span>Absent:</span>
       <strong class="text-danger">@absentCount</strong>
       </div>
          <div class="perf-row">
<span>Late:</span>
   <strong class="text-warning">@lateCount</strong>
             </div>
           </div>
            </div>
   </div>

    <!-- Parent Actions -->
        <div class="col-lg-4 col-md-6 mb-4">
    <div class="dashboard-card">
                <div class="card-header">
      <h5 class="mb-0">
                  <i class="bi bi-lightning"></i> Quick Actions
        </h5>
        </div>
           <div class="card-body d-flex flex-column gap-2">
               <a href="@Url.Action("ParentClasses", "Parent")" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-left"></i> Back to All Classes
 </a>
       <a href="@Url.Action("AttendanceHistory", "Parent")" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-calendar-check"></i> View Full Attendance
        </a>
  <a href="@Url.Action("Dashboard", "Parent")" class="btn btn-outline-primary btn-sm">
    <i class="bi bi-house"></i> Go to Dashboard
            </a>
          </div>
     </div>
        </div>
    </div>

    <!-- Attendance Record -->
    <div class="row">
  <div class="col-12">
            <div class="dashboard-card">
       <div class="card-header">
   <h5 class="mb-0">
         <i class="bi bi-calendar-check"></i> Attendance Record
          </h5>
  </div>
                @if (attendances.Any())
      {
  <div class="table-responsive">
            <table class="table table-sm mb-0">
    <thead>
      <tr>
             <th>Date</th>
      <th>Status</th>
                <th>Time Taken</th>
        <th>Marked By</th>
   </tr>
            </thead>
     <tbody>
            @foreach (var attendance in attendances.Take(20))
            {
   var statusBadgeColor = attendance.Status == "Present" ? "success" : 
  (attendance.Status == "Late" ? "warning" : 
        (attendance.Status == "Absent" ? "danger" : "secondary"));
           
   <tr>
    <td>@attendance.Date.ToString("MMM dd, yyyy")</td>
        <td><span class="badge bg-@statusBadgeColor">@attendance.Status</span></td>
  <td>@attendance.TakenOn.ToString("hh:mm tt")</td>
      <td>@(attendance.MarkedByTeacher?.User?.FullName ?? "System")</td>
  </tr>
      }
       </tbody>
         </table>
                </div>
        @if (attendances.Count > 20)
    {
          <div class="card-body text-center border-top">
         <small class="text-muted">Showing latest 20 records out of @attendances.Count total records</small>
            </div>
        }
      }
         else
     {
          <div class="card-body text-center py-4">
    <i class="bi bi-calendar-x" style="font-size: 2rem; color: #ccc;"></i>
           <p class="text-muted mt-2 mb-0">No attendance records yet for this class</p>
            </div>
       }
            </div>
        </div>
    </div>
</div>

<style>
    .material-item {
     background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        padding: 5px 0;
        margin-bottom: 8px;
        border-bottom: 1px solid #f0f0f0;
 }

    .detail-row:last-child {
     border-bottom: none;
        margin-bottom: 0;
    }

    .detail-row .label {
  font-weight: 600;
   color: #666;
    }

    .detail-row .value {
        text-align: right;
    }

    .perf-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    padding: 8px 0;
   border-bottom: 1px solid #f0f0f0;
    }

    .perf-row:last-child {
border-bottom: none;
    }

    .perf-row span:first-child {
   color: #666;
    }

    .perf-row strong {
        font-weight: 700;
    }
    
    .breadcrumb {
background: transparent;
      padding: 0;
        margin-bottom: 1rem;
    }
</style>
