@{
    ViewBag.Title = "My Children's Classes";
    ViewBag.ActiveMenu = "Classes";
}

@{
    var students = ViewBag.Students as List<WebMobileAssignment.Models.Student> ?? new List<WebMobileAssignment.Models.Student>();
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
        <h1 class="mb-2">My Children's Classes</h1>
            <p class="text-muted">Monitor your children's enrolled classes and performance</p>
        </div>
    </div>

    @if (students.Any())
  {
        @foreach (var student in students)
    {
     var enrollments = student.Enrollments.ToList();
      
  @if (enrollments.Any())
   {
<div class="row mb-5">
   <div class="col-12">
   <h4 class="mb-3">
      <i class="bi bi-person-circle"></i> @student.User.FullName (ID: @student.StudentId)
        </h4>
       </div>

         @foreach (var enrollment in enrollments)
     {
   var classItem = enrollment.Class;
            var teacher = classItem.Teacher;
         var subject = classItem.Subject;
         
// Calculate attendance statistics for this class
           var classAttendances = student.Attendances.Where(a => a.ClassId == classItem.ClassId).ToList();
       var totalAttendance = classAttendances.Count;
var presentCount = classAttendances.Count(a => a.Status == "Present");
     var absentCount = classAttendances.Count(a => a.Status == "Absent");
   var lateCount = classAttendances.Count(a => a.Status == "Late");
         var attendanceRate = totalAttendance > 0 ? Math.Round((decimal)presentCount / totalAttendance * 100, 0) : 0;
          
// Determine class status badge
        var statusBadge = attendanceRate >= 80 ? "success" : (attendanceRate >= 70 ? "warning" : "danger");
   var statusText = attendanceRate >= 80 ? "Good Standing" : (attendanceRate >= 70 ? "Needs Improvement" : "At Risk");
    
          // Random gradient colors for visual variety
           var gradients = new[] {
            "linear-gradient(135deg, #0d6efd 0%, #0d5ee8 100%)",
            "linear-gradient(135deg, #198754 0%, #157347 100%)",
         "linear-gradient(135deg, #ffc107 0%, #e0a800 100%)",
    "linear-gradient(135deg, #17a2b8 0%, #138496 100%)",
       "linear-gradient(135deg, #dc3545 0%, #c82333 100%)"
          };
          var gradientIndex = Math.Abs((classItem.ClassId ?? "").GetHashCode()) % gradients.Length;
  var gradient = gradients[gradientIndex];
            
    <div class="col-lg-4 col-md-6 mb-4">
             <div class="dashboard-card">
    <div class="class-header" style="background: @gradient;">
         <h5 class="mb-0 text-white">@classItem.ClassName</h5>
</div>
     <div class="card-body">
             <div class="class-meta mb-3">
     <span class="badge bg-light text-dark">@(subject?.SubjectName ?? "N/A")</span>
          <span class="badge bg-@statusBadge">@statusText</span>
        </div>
                 <div class="class-details">
   <div class="detail-row">
          <span class="label">Instructor:</span>
              <span class="value">@(teacher?.User?.FullName ?? "Not Assigned")</span>
 </div>
        <div class="detail-row">
  <span class="label">Schedule:</span>
             <span class="value">
    @if (!string.IsNullOrEmpty(classItem.Day) && classItem.StartTime.HasValue)
        {
      @($"{classItem.Day} - {classItem.StartTime.Value:hh\\:mm}")
               }
   else
      {
@("TBA")
      }
             </span>
    </div>
         <div class="detail-row">
                 <span class="label">Room:</span>
       <span class="value">@(classItem.RoomNumber ?? "TBA")</span>
            </div>
               <div class="detail-row">
        <span class="label">Capacity:</span>
                 <span class="value">@classItem.CurrentCapacity / @classItem.MaxCapacity</span>
  </div>
   </div>
   <div class="performance-section mt-3 pt-3 border-top">
     <h6 class="mb-2">Performance</h6>
      <div class="perf-row">
         <span>Attendance:</span>
    <strong class="text-@(attendanceRate >= 80 ? "success" : attendanceRate >= 70 ? "warning" : "danger")">
      @attendanceRate%
        </strong>
      </div>
       <div class="perf-row">
      <span>Total Classes:</span>
       <strong>@totalAttendance</strong>
     </div>
   <div class="perf-row">
  <span>Present:</span>
       <strong class="text-success">@presentCount</strong>
      </div>
        <div class="perf-row">
    <span>Absent:</span>
              <strong class="text-danger">@absentCount</strong>
     </div>
 <div class="perf-row">
       <span>Late:</span>
          <strong class="text-warning">@lateCount</strong>
           </div>
       </div>
    <a href="@Url.Action("ParentClassDetail", "Parent", new { classId = classItem.ClassId, studentId = student.StudentId })" 
          class="btn btn-@statusBadge btn-sm mt-3 w-100">
         @(attendanceRate >= 80 ? "View Details" : "View Details & Improve")
  </a>
      </div>
       </div>
    </div>
     }
        </div>
            }
        else
 {
    <div class="row mb-5">
         <div class="col-12">
         <h4 class="mb-3">
        <i class="bi bi-person-circle"></i> @student.User.FullName (ID: @student.StudentId)
        </h4>
    <div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>No classes enrolled yet.
  </div>
</div>
 </div>
 }
        }
    }
    else
    {
        <div class="row">
    <div class="col-12">
    <div class="alert alert-info text-center">
      <i class="bi bi-info-circle me-2"></i>
  <strong>No children found.</strong>
              <p class="mb-0 mt-2">Please contact the administrator to link your children to your account.</p>
      </div>
            </div>
        </div>
    }
</div>

<style>
    .class-header {
  padding: 15px;
    }

    .class-meta {
        display: flex;
        gap: 5px;
  flex-wrap: wrap;
    }

    .class-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

  .detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        padding: 5px 0;
 }

    .detail-row .label {
      font-weight: 600;
        color: #666;
    }

    .detail-row .value {
        text-align: right;
    }

.performance-section h6 {
        font-weight: 700;
        color: #333;
     font-size: 0.95rem;
    }

    .perf-row {
        display: flex;
 justify-content: space-between;
        font-size: 0.9rem;
        padding: 5px 0;
    }

    .perf-row span:first-child {
        color: #666;
    }

    .perf-row strong {
        font-weight: 700;
    }
</style>
