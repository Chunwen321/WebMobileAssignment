@model IEnumerable<WebMobileAssignment.Models.Class>
@{
    ViewBag.Title = "Class Schedule";
    ViewBag.ActiveMenu = "ClassManagement";
    ViewBag.ActiveSubmenu = "Schedule";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var days = new[] { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" };
    var timeSlots = new List<TimeSpan>();
    
    // Generate time slots from 8 AM to 8 PM (every hour)
    for (int hour = 8; hour <= 20; hour++)
    {
        timeSlots.Add(new TimeSpan(hour, 0, 0));
    }
}

<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-calendar-week-fill text-danger me-2"></i>
                    Class Schedule Timetable
                </h2>
                <p class="text-muted">Visual overview of all class schedules</p>
            </div>
            <div>
                <a asp-action="ClassCreate" class="btn btn-danger">
                    <i class="bi bi-plus-circle me-2"></i>Add Class
                </a>
                <a asp-action="ClassIndex" class="btn btn-outline-danger">
                    <i class="bi bi-list-ul me-2"></i>Class List
                </a>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #0d6efd;">
            <div class="stat-label">Total Classes</div>
            <div class="stat-value text-primary">@Model.Count()</div>
            <small class="text-muted">Scheduled classes</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #198754;">
            <div class="stat-label">Active Days</div>
            <div class="stat-value text-success">@Model.Select(c => c.Day).Distinct().Count()</div>
            <small class="text-muted">Days with classes</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #ffc107;">
            <div class="stat-label">Peak Time</div>
            <div class="stat-value text-warning">
                @{
                    var peakHour = Model
                        .Where(c => c.StartTime.HasValue)
                        .GroupBy(c => c.StartTime.Value.Hours)
                        .OrderByDescending(g => g.Count())
                        .FirstOrDefault();

                    if (peakHour != null)
                    {
                        var hour = peakHour.Key;
                        var period = hour >= 12 ? "PM" : "AM";
                        var displayHour = hour > 12 ? hour - 12 : (hour == 0 ? 12 : hour);
                        @($"{displayHour}:00 {period}")
                    }
                    else
                    {
                        @("N/A")
                    }
                }
            </div>
            <small class="text-muted">Most busy time</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #dc3545;">
            <div class="stat-label">Avg Class Duration</div>
            <div class="stat-value text-danger">
                @{
                    var avgDuration = Model
                        .Where(c => c.StartTime.HasValue && c.EndTime.HasValue)
                        .Average(c => (c.EndTime.Value - c.StartTime.Value).TotalHours);
                }
                @avgDuration.ToString("F1")h
            </div>
            <small class="text-muted">Average length</small>
        </div>
    </div>
</div>

<!-- View Toggle -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-danger active" onclick="showView('timetable')">
                <i class="bi bi-calendar3"></i> Timetable View
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="showView('daily')">
                <i class="bi bi-list-columns-reverse"></i> Daily View
            </button>
        </div>
    </div>
</div>

<!-- Timetable View -->
<div id="timetableView" class="row">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header-custom">
                <h5 class="card-title">
                    <i class="bi bi-table"></i>
                    Weekly Timetable
                </h5>
                <div class="legend">
                    <span class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                        Morning (8AM-12PM)
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></span>
                        Afternoon (12PM-5PM)
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></span>
                        Evening (5PM-8PM)
                    </span>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="timetable">
                    <thead>
                        <tr>
                            <th class="time-column">Time</th>
                            @foreach (var day in days)
                            {
                                <th class="day-column">
                                    <div class="day-header">
                                        <i class="bi bi-calendar-day"></i>
                                        @day
                                    </div>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var timeSlot in timeSlots)
                        {
                            <tr>
                                <td class="time-cell">
                                    @{
                                        var hour = timeSlot.Hours;
                                        var period = hour >= 12 ? "PM" : "AM";
                                        var displayHour = hour > 12 ? hour - 12 : (hour == 0 ? 12 : hour);
                                    }
                                    <strong>@displayHour:00</strong> @period
                                </td>
                                @foreach (var day in days)
                                {
                                    var classesInSlot = Model.Where(c => 
                                        c.Day == day && 
                                        c.StartTime.HasValue && 
                                        c.StartTime.Value <= timeSlot && 
                                        c.EndTime.HasValue && 
                                        c.EndTime.Value > timeSlot
                                    ).ToList();

                                    <td class="schedule-cell">
                                        @foreach (var cls in classesInSlot)
                                        {
                                            var duration = (cls.EndTime.Value - cls.StartTime.Value).TotalHours;
                                            var rowspan = (int)Math.Ceiling(duration);
                                            
                                            // Only render if this is the start time
                                            if (cls.StartTime.Value.Hours == timeSlot.Hours)
                                            {
                                                var gradientClass = timeSlot.Hours < 12 ? "morning" : (timeSlot.Hours < 17 ? "afternoon" : "evening");
                                                var fillPercentage = cls.MaxCapacity > 0 ? (decimal)cls.CurrentCapacity / cls.MaxCapacity * 100 : 0;
                                                
                                                <div class="class-block @gradientClass" title="@cls.ClassName">
                                                    <div class="class-block-header">
                                                        <strong>@cls.ClassName</strong>
                                                        @if (fillPercentage >= 90)
                                                        {
                                                            <span class="badge bg-warning text-dark">
                                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                            </span>
                                                        }
                                                    </div>
                                                    <div class="class-block-info">
                                                        <div class="info-line">
                                                            <i class="bi bi-clock"></i>
                                                            @{
                                                                var startTime = cls.StartTime.Value.ToString("hh\\:mm");
                                                                var endTime = cls.EndTime.Value.ToString("hh\\:mm");
                                                            }
                                                            @startTime - @endTime
                                                        </div>
                                                        <div class="info-line">
                                                            <i class="bi bi-person"></i>
                                                            @if (cls.Teacher != null)
                                                            {
                                                                @cls.Teacher.User.FullName
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">TBA</span>
                                                            }
                                                        </div>
                                                        <div class="info-line">
                                                            <i class="bi bi-geo-alt"></i>
                                                            @(cls.RoomNumber ?? "TBA")
                                                        </div>
                                                        <div class="info-line">
                                                            <i class="bi bi-people"></i>
                                                            @cls.CurrentCapacity/@cls.MaxCapacity students
                                                        </div>
                                                    </div>
                                                    <div class="class-block-footer">
                                                        <a asp-action="ClassDetails" asp-route-id="@cls.ClassId" class="btn-link-white">
                                                            <i class="bi bi-eye"></i> View
                                                        </a>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Daily View -->
<div id="dailyView" class="row d-none">
    @foreach (var day in days)
    {
        var classesForDay = Model.Where(c => c.Day == day).OrderBy(c => c.StartTime).ToList();
        
        if (classesForDay.Any())
        {
            <div class="col-12 mb-4">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5 class="card-title">
                            <i class="bi bi-calendar-day me-2"></i>
                            @day
                            <span class="badge bg-danger ms-2">@classesForDay.Count classes</span>
                        </h5>
                    </div>
                    <div class="row g-3 p-3">
                        @foreach (var cls in classesForDay)
                        {
                            var fillPercentage = cls.MaxCapacity > 0 ? (decimal)cls.CurrentCapacity / cls.MaxCapacity * 100 : 0;
                            var timeSlotHour = cls.StartTime?.Hours ?? 0;
                            var gradientClass = timeSlotHour < 12 ? "morning" : (timeSlotHour < 17 ? "afternoon" : "evening");
                            
                            <div class="col-lg-3 col-md-4 col-sm-6">
                                <div class="daily-class-card @gradientClass">
                                    <div class="daily-class-time">
                                        <i class="bi bi-clock-fill"></i>
                                        @{
                                            // Convert TimeSpan to formatted time with AM/PM
                                            var startHour = cls.StartTime.Value.Hours;
                                            var startMin = cls.StartTime.Value.Minutes;
                                            var startPeriod = startHour >= 12 ? "PM" : "AM";
                                            var startDisplayHour = startHour > 12 ? startHour - 12 : (startHour == 0 ? 12 : startHour);
                                            var dailyStartTime = $"{startDisplayHour:D2}:{startMin:D2} {startPeriod}";
                                            
                                            var endHour = cls.EndTime.Value.Hours;
                                            var endMin = cls.EndTime.Value.Minutes;
                                            var endPeriod = endHour >= 12 ? "PM" : "AM";
                                            var endDisplayHour = endHour > 12 ? endHour - 12 : (endHour == 0 ? 12 : endHour);
                                            var dailyEndTime = $"{endDisplayHour:D2}:{endMin:D2} {endPeriod}";
                                        }
                                        @dailyStartTime - @dailyEndTime
                                    </div>
                                    <div class="daily-class-name">
                                        @cls.ClassName
                                    </div>
                                    <div class="daily-class-details">
                                        <div class="detail-item">
                                            <i class="bi bi-person"></i>
                                            @(cls.Teacher?.User.FullName ?? "TBA")
                                        </div>
                                        <div class="detail-item">
                                            <i class="bi bi-geo-alt"></i>
                                            @(cls.RoomNumber ?? "TBA")
                                        </div>
                                        <div class="detail-item">
                                            <i class="bi bi-people"></i>
                                            @cls.CurrentCapacity/@cls.MaxCapacity
                                        </div>
                                    </div>
                                    <div class="daily-class-progress">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar @(fillPercentage >= 90 ? "bg-danger" : "bg-success")"
                                                 style="width: @fillPercentage%"></div>
                                        </div>
                                    </div>
                                    <div class="daily-class-actions">
                                        <a asp-action="ClassDetails" asp-route-id="@cls.ClassId" class="btn btn-sm btn-light">
                                            <i class="bi bi-eye"></i> Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        function showView(view) {
            const timetableView = document.getElementById('timetableView');
            const dailyView = document.getElementById('dailyView');
            const buttons = document.querySelectorAll('.btn-group .btn');

            if (view === 'timetable') {
                timetableView.classList.remove('d-none');
                dailyView.classList.add('d-none');
                buttons[0].classList.add('active', 'btn-danger');
                buttons[0].classList.remove('btn-outline-danger');
                buttons[1].classList.remove('active', 'btn-danger');
                buttons[1].classList.add('btn-outline-danger');
            } else {
                timetableView.classList.add('d-none');
                dailyView.classList.remove('d-none');
                buttons[0].classList.remove('active', 'btn-danger');
                buttons[0].classList.add('btn-outline-danger');
                buttons[1].classList.add('active', 'btn-danger');
                buttons[1].classList.remove('btn-outline-danger');
            }
        }
    </script>
}

<style>
    /* Timetable Styles */
    .timetable {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .time-column {
        width: 100px;
        background: #f8f9fa;
        position: sticky;
        left: 0;
        z-index: 2;
    }

    .day-column {
        min-width: 180px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 15px;
        text-align: center;
    }

    .day-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .time-cell {
        padding: 15px;
        background: #f8f9fa;
        border-right: 2px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.9rem;
        position: sticky;
        left: 0;
        z-index: 1;
    }

    .schedule-cell {
        padding: 5px;
        border: 1px solid #e0e0e0;
        vertical-align: top;
        min-height: 80px;
        position: relative;
    }

    .class-block {
        padding: 12px;
        border-radius: 8px;
        color: white;
        margin-bottom: 5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .class-block:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .class-block.morning {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .class-block.afternoon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .class-block.evening {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .class-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        font-size: 0.95rem;
    }

    .class-block-info {
        font-size: 0.85rem;
        margin-bottom: 8px;
    }

    .info-line {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
        opacity: 0.95;
    }

    .class-block-footer {
        text-align: right;
    }

    .btn-link-white {
        color: white;
        text-decoration: none;
        font-size: 0.85rem;
        opacity: 0.9;
        transition: opacity 0.2s;
    }

    .btn-link-white:hover {
        opacity: 1;
        text-decoration: underline;
    }

    /* Legend */
    .legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        display: inline-block;
    }

    /* Daily View Styles */
    .daily-class-card {
        padding: 15px;
        border-radius: 10px;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .daily-class-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .daily-class-time {
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.95rem;
    }

    .daily-class-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.3);
    }

    .daily-class-details {
        flex-grow: 1;
        margin-bottom: 10px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
        font-size: 0.9rem;
        opacity: 0.95;
    }

    .daily-class-progress {
        margin-bottom: 10px;
    }

    .daily-class-actions {
        text-align: center;
    }

    /* Print Styles */
    @@media print {
        .topbar, .sidebar, .btn, .legend {
            display: none !important;
        }

        .page-content {
            margin: 0;
            padding: 20px;
        }

        .timetable {
            font-size: 10px;
        }

        .class-block {
            page-break-inside: avoid;
            box-shadow: none;
        }
    }

    /* Responsive */
    @@media (max-width: 992px) {
        .timetable {
            font-size: 0.85rem;
        }

        .day-column {
            min-width: 120px;
        }

        .class-block {
            padding: 8px;
        }
    }
</style>
